---
title: "New mediator genes"
author: "Jinliang Yang"
date: "1-12-2021"
output: NULL
---


## Normalize the path:

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
knitr::opts_knit$set(root.dir=normalizePath('../../')) 
```

- Direct SNP: /common/jyanglab/zhikaiyang/projects/mediation/largedata/dsnps_vs_gwas/dsnps_34013rows.csv
- Indirect SNP: /common/jyanglab/zhikaiyang/projects/mediation/largedata/isnps_vs_feature/isnps_47143rows.csv
- Mediators: data/mediators_18812rows_by_cat.csv

### Mediators

```{r}
m <- read.csv("data/mediators_18812rows_by_cat.csv")
table(m$method)
```
- eq: MedFix0.5
- fixed: MedFixBIC

- e2m: p-values for the exposure effect on the individual mediators
- m2y: p-values for the mediator effect on phenotype
- e2m2y: min value among c(1, max(e2m, m2y))

```{r}
# res.eq
m1 <- subset(m, method %in% "res.fixed" & padj <= 0.05)
nrow(m1) # 932
length(unique(m1$id)) # 736

pertrait <- data.frame(table(m1$trait))
mean(pertrait$Freq)


library(plyr)
nt <- ddply(m1, .(tissue, category, trait), nrow)

percat <- ddply(nt, .(tissue, category), summarise,
                m=mean(V1),
                sd=sd(V1))


```

# Number of mediator genes by category and trait

```{r}
fsize=18
nt$tissue <- factor(nt$tissue, levels = c( "GRoot", "GShoot", "L3Base", "L3Tip", "LMAD", "LMAN","Kern"),
                    labels =c( "Germinating Root", "Germinating Shoot", "Leaf 3 base", "Leaf 3 tip", "Adult leaf during the day", "Adult leaf at night","Kernels after pollination"))

library(ggplot2)
pall <- ggplot(nt, aes(x=tissue, y=V1, fill=category)) +
    #geom_bar(stat="identity", position=position_dodge()) +
    geom_boxplot(outlier.colour="black", outlier.shape=16, 
             outlier.size=1, notch=FALSE) +
    # scale_fill_manual(values=c("#69b3a2", "#cdc0b0")) +
    # scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    # geom_jitter(color="#cc4141", size=2, alpha=0.9) +
    xlab("") +
    ylab("Proportion of variance mediated") +
    ggtitle("") +
    theme_classic() +
    labs(fill = "") +
    #scale_y_continuous(limits = c(-0.01, 1)) +
    theme(plot.title = element_text(size=20, face = "bold"), 
          axis.text=element_text(size=16, face="bold"),
          strip.text.x = element_text(size = 16, face = "bold"),
          axis.title=element_text(size=fsize, face="bold"),
          axis.text.x = element_text(angle = 15, hjust=0.8),
          legend.position = c(0.2, 0.8), 
          legend.title = element_text(size=fsize, face="bold"),
          legend.text = element_text(size=fsize))
pall

pdf("graphs/pvm_all_traits.pdf", width = 9, height= 6)
pall
dev.off()
```





```{r}
library(data.table)
ag <- subset()

m <- subset(m, padj < 0.05)

top <- data.frame(table(m$id))
top <- top[order(top$Freq, decreasing = T),]

#top10 = subset(m, id %in% top$Var1[1:10])
m = merge(m, top, by.x = "id", by.y = "Var1", all.x = T)
library(dplyr)
m = arrange(m, desc(Freq), id)

#idx <- which(top$Var1 %in% "GRMZM2G171650")


#head(m)

#subset(m, id %in% "GRMZM2G171650")

V3_V4 <- fread("./largedata/V3_V4.csv", header = FALSE , data.table=FALSE)
V3_V4 <- V3_V4[,c(1,2)]
Zea_mays.AGPv4_anno <- fread("./largedata/Zea_mays.AGPv4_anno.txt", header = TRUE, data.table = FALSE)
Zea_mays.AGPv34_anno <- merge(V3_V4, Zea_mays.AGPv4_anno, by.x = "V2", by.y = "ensembl_gene_id_v4")
top_anno = merge(top, Zea_mays.AGPv34_anno, by.x = "Var1", by.y = "V1")


newgenes = fread("largedata/new_genes.txt")

id = which(top$Var1 %in% newgenes$`Gene Model`)
top_newgenes = merge(top, newgenes, by.x = "Var1", by.y = "Gene Model")

bx13 = subset(m, id == "AC148152.3_FG005")
bx13 = arrange(bx13, category, padj)
```



Lin's known genes overlap


```{r}
library("readxl")

m <- read.csv("data/mediators_18812rows_by_cat.csv")

f <- list.files(path="largedata/lin_known_genes/", pattern=".*", full.names = T)

out <- data.frame()
for(i in 1:length(f)){
  tem <- read_excel(f[i])
  tem$file <- f[i]
  out <- rbind(out, tem)
}

out$trait  <- gsub(".*genes\\/|\\.xls", "", out$file)

out$trait[which(out$trait == "DaystoSilk2")] = "DaystoSilk"
traits = data.frame(table(out$trait))

overlap_known = data.frame()
overlap_m = data.frame()
for (i in 1:nrow(traits)) {
  tem_known = subset(out, trait == traits$Var1[i])
  tem_m = subset(m, trait == traits$Var1[i])
  id = which(tem_m$id %in% tem_known$Gene_refGene)
  overlap_m = rbind(overlap_m, tem_m[id,])
  id = which(tem_known$Gene_refGene %in% tem_m$id)
  overlap_known = rbind(overlap_known, tem_known[id, ])
}


overlap = merge(overlap_m[,c(2,6,9:11)], overlap_known[,c(36,23:25,27, 13,20,22)], by.x = "id", by.y = "Gene_refGene", all.x = T) 

write.table(overlap, "largedata/overlap_lin_known_genes.csv", sep = ",", row.names = F)




```



---
title: "Collect mediation analysis results"
author: "Jinliang Yang"
date: "10-12-2020"
output: NULL
---


## Normalize the path:

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
knitr::opts_knit$set(root.dir=normalizePath('../../')) 
```

### Results generated by Zhikai

/common/jyanglab/zhikaiyang/projects/mediation/largedata/med_output

fixed_dsnps : direct snps
fixed_indirect : indirect snps
fixed_mediator_trait : mediator for agronomic traits
fixed_mediator_X...: mediator for metabolic traits
fixe.pcut_sum : pvm


### Mediators

```{r}

f <- list.files(path="/common/jyanglab/zhikaiyang/projects/mediation/largedata/med_output/", pattern="mediator_", full.names = T)

out <- data.frame()
for(i in 1:length(f)){
  tem <- read.csv(f[i], header=TRUE)
  tem$file <- f[i]
  out <- rbind(out, tem)
}

out$file  <- gsub(".*\\/", "", out$file)
# method
out$method <- gsub("_.*", "", out$file)
# tissue type
out$tissue <- gsub(".*_ts_|.csv", "", out$file)
table(out$tissue)
# trait
out$trait <- gsub(".*mediator_|_ts.*", "", out$file)
table(out$trait)

write.table(out, "cache/mediators_23296rows.csv", sep=",", row.names=FALSE, quote=FALSE)
```


### Filter non-significant ones

```{r}
m <- read.csv("cache/mediators_23296rows.csv")
m5 <- subset(m, padj < 0.05)
# nrow(m5) 2751
m1 <- subset(m, padj < 0.01)
# 1567

t5 <- as.data.frame(table(m5$id))
t5 <- t5[order(t5$Freq, decreasing=T),]
```

If focus on only the metabolite traits

```{r}
idx <- grep("X\\.", m5$trait)
mt <- m5[idx, ]
mt <- subset(mt, method == "res.fixed") 

tp <- as.data.frame(table(mt$id))
tp <- tp[order(tp$Freq, decreasing = T),]

library(data.table)
fwrite(as.list(tp[,1]), "largedata/mediators_m.txt", sep = "\n", row.names = F, quote = F )

fg005 <- subset(mt, id %in% "AC148152.3_FG005")

fg005 <- subset(m, id %in% "AC148152.3_FG005")
```











### read in data metabolites on HCC

```{r}
library(data.table)
f <- list.files(path="largedata/med_output", pattern="fixed.pcut_sum_X", full.names = T)

out <- data.frame()
for(i in 1:length(f)){
  tem <- read.csv(f[i], header=TRUE)
  tem$file <- f[i]
  out <- rbind(out, tem)
}

out$trait  <- gsub(".*sum_|_ts.*", "", out$file)
out$tissue  <- gsub(".*_ts_|.csv", "", out$file)
fwrite(out[,-8],"largedata/sum_out_metabolites.txt", sep="\t", row.names = F, quote = F)
```

### Assign category

Zhikai, double-check the trait category assignment!

df_medfixbic$traits[1:7] <- rep("anthesis to silk interval")
df_medfixbic$traits[8:14] <- rep("days to tassel")
df_medfixbic$traits[15:21]<- rep("days to silk")
df_medfixbic$traits[22:28] <- rep("gdd anthesis to silk interval")
df_medfixbic$traits[29:35] <- rep("gdd to tassel")
df_medfixbic$traits[36:42]<- rep("gdd to silk")
df_medfixbic$traits[43:49] <- rep("plant height")
df_medfixbic$traits[50:56] <- rep("ear height")
df_medfixbic$traits[57:63]<- rep("leaf length")
df_medfixbic$traits[64:70] <- rep("leaf width")
df_medfixbic$traits[71:77] <- rep("uper leaf angle")
df_medfixbic$traits[78:84]<- rep("tassel length")
df_medfixbic$traits[85:91] <- rep("tassel primary branches")
df_medfixbic$traits[92:98] <- rep("cob diameter")
df_medfixbic$traits[99:105]<- rep("cob length")
df_medfixbic$traits[106:112] <- rep("cob mass")
df_medfixbic$traits[113:119] <- rep("number of kernel per row")
df_medfixbic$traits[120:126]<- rep("ear row number")
df_medfixbic$traits[127:133] <- rep("ear mass")
df_medfixbic$traits[134:140] <- rep("total kernel volume")
df_medfixbic$traits[141:147]<- rep("twenty kernel weight")

```{r}
library(ggplot2)
# library(ggpubr)
library(dplyr)

df <- subset(out, method %in% "medfixbic")
df$trait <- as.character(df$trait)

### assign category: 
df$cat <- "1"
# df[df$trait %in% c("asi", "daystosilk", "daystotassel", "gddasi", "gddtosilk", "gddtoassel"), ]$cat <- "Flowering"
#df[df$trait %in% c("asi", "daystosilk", "daystotassel"), ]$cat <- "Flowering Time"
df[df$trait %in% c("asi", "daystosilk", "daystotassel"), ]$cat <- "Flowering Time"
df[df$trait %in% c("eh", "planth"), ]$cat <- "Development"
df[df$trait %in% c("ll", "lw", "ula"), ]$cat <- "Leaf morphology"
df[df$trait %in% c("tpb", "tsl"), ]$cat <- "Male Inflorescence"
df[df$trait %in% c("cobd", "cobl", "ern", "ekpr"), ]$cat <- "Female Inflorescence"
df[df$trait %in% c("earm", "cobw", "tkv", "twkw", "kw","knum"), ]$cat <- "Seed traits"

table(df$cat)

```

### Assign category metabolites
```{r}
library(ggplot2)
# library(ggpubr)
library(dplyr)

df_m <- fread("largedata/sum_out_metabolites.txt", header= T, data.table=F)

### assign category: 
df_m$cat <- "metabolite"

```


### Visualization p7m

```{r}

fsize=18
df$tissue <- factor(df$tissue, levels = c( "groot", "gs", "l3b", "l3t", "ld268", "ln268","kern"),
                    labels =c( "Germinating Root", "Germinating Shoot", "Leaf 3 base", "Leaf 3 tip", "Adult leaf during the day", "Adult leaf at night","Kernels after pollination"))


df0 <- subset(df, cat != "1")
pall <- ggplot(df0, aes(x=tissue, y=pmed.pure, fill=cat)) +
    #geom_bar(stat="identity", position=position_dodge()) +
    geom_boxplot(outlier.colour="black", outlier.shape=16, 
             outlier.size=1, notch=FALSE) +
    # scale_fill_manual(values=c("#69b3a2", "#cdc0b0")) +
    # scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    # geom_jitter(color="#cc4141", size=2, alpha=0.9) +
    xlab("") +
    ylab("Proportion of variance mediated") +
    ggtitle("") +
    theme_classic() +
    labs(fill = "") +
    scale_y_continuous(limits = c(-0.01, 1)) +
    theme(plot.title = element_text(size=20, face = "bold"), 
          axis.text=element_text(size=16, face="bold"),
          strip.text.x = element_text(size = 16, face = "bold"),
          axis.title=element_text(size=fsize, face="bold"),
          axis.text.x = element_text(angle = 15, hjust=0.8),
          legend.position = c(0.2, 0.8), 
          legend.title = element_text(size=fsize, face="bold"),
          legend.text = element_text(size=fsize))
pall

pdf("graphs/pvm_all_traits.pdf", width = 9, height= 6)
pall
dev.off()
```


```{r}
df1 <- subset(df, cat %in% "Flowering Time")

p1 <- ggplot(df1, aes(y=tissue, x=pmed.pure, fill=tissue)) +
    #geom_bar(stat="identity", position=position_dodge()) +
    geom_boxplot(outlier.colour="black", outlier.shape=16, 
             outlier.size=2, notch=FALSE) +
    scale_fill_manual(values=rep("#69b3a2", 7), guide=FALSE) +
    # scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="#cc4141", size=2, alpha=0.9) +
    xlab("") +
    ylab("") +
    ggtitle("Flowering Time Traits") +
    theme_classic() +
    scale_x_continuous(limits = c(-0.01, 1)) +
    theme(plot.title = element_text(size=20, face = "bold"), 
          axis.text=element_text(size=16, face="bold"),
          strip.text.x = element_text(size = 16, face = "bold"),
          axis.title=element_text(size=fsize, face="bold"),
          # axis.text.x = element_text(angle = 20),
          legend.position = "none", 
          legend.title = element_text(size=fsize, face="bold"),
          legend.text = element_text(size=fsize))
p1


```

```{r}
df2 <- subset(df, cat %in% "Seed traits")
p2 <- ggplot(df2, aes(y=tissue, x=pmed.pure, fill=tissue)) +
    #geom_bar(stat="identity", position=position_dodge()) +
    geom_boxplot(outlier.colour="black", outlier.shape=16, 
             outlier.size=2, notch=FALSE) +
    scale_fill_manual(values=rep("#cdc0b0", 7), guide=FALSE) +
    # scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="#cc4141", size=2, alpha=0.9) +
    xlab("Proportion of variance mediated") +
    ylab("") +
    ggtitle("Seed Traits") +
    theme_classic() +
    scale_x_continuous(limits = c(-0.01, 1)) +
    theme(plot.title = element_text(size=20, face = "bold"), 
          axis.text=element_text(size=16, face="bold"),
          strip.text.x = element_text(size = 16, face = "bold"),
          axis.title=element_text(size=fsize, face="bold"),
          # axis.text.x = element_text(angle = 20),
          legend.position = "none", 
          legend.title = element_text(size=fsize, face="bold"),
          legend.text = element_text(size=fsize))
p2
```

```{r}
df3 <- subset(df, cat %in% "Leaf morphology")

p3 <- ggplot(df3, aes(y=tissue, x=pmed.pure, fill=tissue)) +
    #geom_bar(stat="identity", position=position_dodge()) +
    geom_boxplot(outlier.colour="black", outlier.shape=16, 
             outlier.size=2, notch=FALSE) +
    scale_fill_manual(values=rep("#69b3a2", 7), guide=FALSE) +
    # scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="#cc4141", size=2, alpha=0.9) +
    xlab("Proportion of variance mediated") +
    ylab("") +
    ggtitle("Leaf morphology") +
    theme_classic() +
    scale_x_continuous(limits = c(-0.01, 1)) +
    theme(plot.title = element_text(size=20, face = "bold"), 
          axis.text=element_text(size=16, face="bold"),
          strip.text.x = element_text(size = 16, face = "bold"),
          axis.title=element_text(size=fsize, face="bold"),
          # axis.text.x = element_text(angle = 20),
          legend.position = "none", 
          legend.title = element_text(size=fsize, face="bold"),
          legend.text = element_text(size=fsize))
p3
```

```{r}
df4 <- subset(df, cat %in% "Inflorescence") #Female or Male

p4 <- ggplot(df4, aes(y=tissue, x=pmed.pure, fill=tissue)) +
    #geom_bar(stat="identity", position=position_dodge()) +
    geom_boxplot(outlier.colour="black", outlier.shape=16, 
             outlier.size=2, notch=FALSE) +
    scale_fill_manual(values=rep("#69b3a2", 7), guide=FALSE) +
    # scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="#cc4141", size=2, alpha=0.9) +
    xlab("Proportion of variance mediated") +
    ylab("") +
    ggtitle("Inflorescence") +
    theme_classic() +
    scale_x_continuous(limits = c(-0.01, 1)) +
    theme(plot.title = element_text(size=20, face = "bold"), 
          axis.text=element_text(size=16, face="bold"),
          strip.text.x = element_text(size = 16, face = "bold"),
          axis.title=element_text(size=fsize, face="bold"),
          # axis.text.x = element_text(angle = 20),
          legend.position = "none", 
          legend.title = element_text(size=fsize, face="bold"),
          legend.text = element_text(size=fsize))
p4
```


```{r}
df5 <- subset(df, cat %in% "Development")
p5 <- ggplot(df5, aes(y=tissue, x=pmed.pure, fill=tissue)) +
    #geom_bar(stat="identity", position=position_dodge()) +
    geom_boxplot(outlier.colour="black", outlier.shape=16, 
             outlier.size=2, notch=FALSE) +
    scale_fill_manual(values=rep("#69b3a2", 7), guide=FALSE) +
    # scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="#cc4141", size=2, alpha=0.9) +
    xlab("Proportion of variance mediated") +
    ylab("") +
    ggtitle("Development") +
    theme_classic() +
    scale_x_continuous(limits = c(-0.01, 1)) +
    theme(plot.title = element_text(size=20, face = "bold"), 
          axis.text=element_text(size=16, face="bold"),
          strip.text.x = element_text(size = 16, face = "bold"),
          axis.title=element_text(size=fsize, face="bold"),
          # axis.text.x = element_text(angle = 20),
          legend.position = "none", 
          legend.title = element_text(size=fsize, face="bold"),
          legend.text = element_text(size=fsize))
p5
```




```{r}
library(cowplot)

pdf("graphs/pvm_flowering_seed.pdf", width = 7, height= 8)
plot_grid(p1, p2, labels = "AUTO", nrow=2, ncol=1, label_size = 20, align = "v")
dev.off()
```
```{r}
df12 <- rbind(df1, df2)

df12$cat <- factor(df12$cat, levels = c("Flowering", "Seed traits"),
                    labels =c("Flowering Time", "Seed traits"))


p12 <- ggplot(df12, aes(y=tissue, x=pmed.pure, fill=cat)) +
    #geom_bar(stat="identity", position=position_dodge()) +
    geom_boxplot(outlier.colour="black", outlier.shape=16, 
             outlier.size=1, notch=FALSE) +
    scale_fill_manual(values=c("#69b3a2", "#cdc0b0")) +
    # scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    # geom_jitter(color="#cc4141", size=2, alpha=0.9) +
    xlab("Proportion of variance mediated") +
    ylab("") +
    ggtitle("") +
    theme_classic() +
    labs(fill = "") +
    scale_x_continuous(limits = c(-0.01, 1)) +
    theme(plot.title = element_text(size=20, face = "bold"), 
          axis.text=element_text(size=16, face="bold"),
          strip.text.x = element_text(size = 16, face = "bold"),
          axis.title=element_text(size=fsize, face="bold"),
          # axis.text.x = element_text(angle = 20),
          legend.position = c(0.7, 0.7), 
          legend.title = element_text(size=fsize, face="bold"),
          legend.text = element_text(size=fsize))
p12


pdf("graphs/pvm_flowering_seedv2.pdf", width = 7, height= 5)
p12
dev.off()
```

### Visualization metabolites
```{r}


pm <- ggplot(df_m, aes(y=tissue, x=pmed.pure, fill=tissue)) +
    #geom_bar(stat="identity", position=position_dodge()) +
    geom_boxplot(outlier.colour="black", outlier.shape=16, 
             outlier.size=2, notch=FALSE) +
    scale_fill_manual(values=rep("#69b3a2", 7), guide=FALSE) +
    # scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="#cc4141", size=2, alpha=0.9) +
    xlab("") +
    ylab("") +
    ggtitle("Metabolic Traits") +
    theme_classic() +
    scale_x_continuous(limits = c(-0.01, 1)) +
    theme(plot.title = element_text(size=20, face = "bold"), 
          axis.text=element_text(size=16, face="bold"),
          strip.text.x = element_text(size = 16, face = "bold"),
          axis.title=element_text(size=fsize, face="bold"),
          # axis.text.x = element_text(angle = 20),
          legend.position = "none", 
          legend.title = element_text(size=fsize, face="bold"),
          legend.text = element_text(size=fsize))
pm


```





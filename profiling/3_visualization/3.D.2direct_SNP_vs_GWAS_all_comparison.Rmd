---
title: "Collect mediation analysis results"
author: "Zhikai Yang "
date: "11-2-2020"
output: NULL
---


## Normalize the path:

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
knitr::opts_knit$set(root.dir=normalizePath('../../')) 
```

### Results generated by Zhikai

/common/jyanglab/zhikaiyang/projects/mediation/largedata/med_output

fixed_dsnps : direct snps
fixed_indirect : indirect snps
fixed_mediator_trait : mediator for agronomic traits
fixed_mediator_X...: mediator for metabolic traits
fixe.pcut_sum : pvm


### on HCC

```{r}

f <- list.files(path="/common/jyanglab/zhikaiyang/projects/mediation/largedata/med_output/", pattern="_dsnps_", full.names = T)

out <- data.frame()
for(i in 1:length(f)){
  tem <- read.csv(f[i], header=TRUE)
  tem$file <- f[i]
  out <- rbind(out, tem)
}

out$file  <- gsub(".*\\/", "", out$file)

library(data.table)

snps_p7msnps <- fread("/common/jyanglab/zhikaiyang/projects/mediation-analysis/largedata/code2020/gen/allchr_bisnp_n282_snpid_maf01_geno2_pruned.bim", header = FALSE , data.table=FALSE)
out <- merge(out, snps_p7msnps[,c(1,2,4)], by.x = "snp", by.y = "V2", sort = F, all.x = T)
colnames(out)[c(5,6)] = c("chr", "pos")
# method
out$method <- gsub("_.*", "", out$file)
# tissue type
out$tissue <- gsub(".*_ts_|.csv", "", out$file)
table(out$tissue)
# trait
out$trait <- gsub(".*dsnps_|_ts.*", "", out$file)
table(out$trait)

write.table(out, "largedata/dsnps_vs_gwas/dsnps_20149rows.csv", sep=",", row.names=FALSE, quote=FALSE)
```


### on local

```{r}
dsnps <- fread("largedata/dsnps_vs_gwas/dsnps_20149rows.csv")
all_gwas <- fread("largedata/dsnps_vs_gwas/all_traits.all_res.txt")
which(all_gwas$Chr == dsnps$chr[1] & all_gwas$start < dsnps$pos[1] & all_gwas$end > dsnps$pos[1] & all_gwas$date == dsnps$trait[1])
idx <- grep("X\\.", all_gwas$date)
all_gwas$date[idx] <- gsub("\\.$", "", all_gwas$date[idx])
dsnps$gwas_overlap <- 0

idx <- grep("P368\\.", dsnps$trait)
dsnps = dsnps[- idx,]

for (i in 1:nrow(dsnps)) {
  if (length(which(all_gwas$Chr == dsnps$chr[i] & all_gwas$start < dsnps$pos[i] & all_gwas$end > dsnps$pos[i] & all_gwas$date == dsnps$trait[i])) != 0) {
    dsnps$gwas_overlap[i] = which(all_gwas$Chr == dsnps$chr[i] & all_gwas$start < dsnps$pos[i] & all_gwas$end > dsnps$pos[i] & all_gwas$date == dsnps$trait[i])
  }
  
}

dsnps_eq <- subset(dsnps, method == "res.eq")
dsnps_fixed <- subset(dsnps, method == "res.fixed")
i_trait_eq <- unique(dsnps_eq$trait)
i_tissue_eq <- unique(dsnps_eq$tissue)
gwas_overlap_eq = NULL
for (trait in i_trait_eq) {
  
  for (tissue in i_tissue_eq) {
    t = intersect(which(dsnps_eq$trait == trait ), which( dsnps_eq$tissue == tissue))
    if (length(t) > 0) {
      tem = dsnps_eq[t, ]
      o_ratio = length(which(tem$gwas_overlap != 0))/nrow(tem)
      gwas_overlap_eq = rbind(gwas_overlap_eq, c(trait, tissue, o_ratio, length(which(tem$gwas_overlap != 0)), nrow(tem) ))
    }
    
  }
  
}


i_trait_fixed <- unique(dsnps_fixed$trait)
i_tissue_fixed <- unique(dsnps_fixed$tissue)
gwas_overlap_fixed = NULL
for (trait in i_trait_fixed) {
  
  for (tissue in i_tissue_fixed) {
    t = intersect(which(dsnps_fixed$trait == trait ), which( dsnps_fixed$tissue == tissue))
    if (length(t) > 0) {
      tem = dsnps_fixed[t, ]
      o_ratio = length(which(tem$gwas_overlap != 0))/nrow(tem)
      gwas_overlap_fixed = rbind(gwas_overlap_fixed, c(trait, tissue, o_ratio, length(which(tem$gwas_overlap != 0)), nrow(tem) ))
    }
    
  }
  
}
```

```{r}
ag_trait <- fread("data/geno_trait.txt")
m_trait <- fread("data/metabolite_rep1_genotype_namecorrect.txt")
trait_category <- data.frame(category = "other", trait = c(colnames(ag_trait)[-1], colnames(m_trait)[-1]))

trait_category$category[c(3,4,11:13,38)]= "Flowering Time"
trait_category$category[c(6,23)]= "Development"
trait_category$category[c(15,16,36)]= "Leaf Morphology"
trait_category$category[c(32,33)]= "Male Inflorescence"
trait_category$category[c(1,7,9,8)]= "Female Inflorescence"
trait_category$category[c(2,10,35,37,39,40)]= "Seed Traits"
trait_category$category[41:106]= "Metabolite"
```


---
title: "Collect mediation analysis results"
author: "Zhikai Yang & Jinliang Yang"
date: "10-20-2020"
output: NULL
---


## Normalize the path:

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
knitr::opts_knit$set(root.dir=normalizePath('../../')) 
```

### Results generated by Zhikai

/common/jyanglab/zhikaiyang/projects/mediation/largedata/med_output

fixed_dsnps : direct snps
fixed_indirect : indirect snps
fixed_mediator_trait : mediator for agronomic traits
fixed_mediator_X...: mediator for metabolic traits
fixe.pcut_sum : pvm


### Mediators

```{r}

f <- list.files(path="/common/jyanglab/zhikaiyang/projects/mediation/largedata/med_output/", pattern="mediator_", full.names = T)

out <- data.frame()
for(i in 1:length(f)){
  tem <- read.csv(f[i], header=TRUE)
  tem$file <- f[i]
  out <- rbind(out, tem)
}

out$file  <- gsub(".*\\/", "", out$file)
# method
out$method <- gsub("_.*", "", out$file)
# tissue type
out$tissue <- gsub(".*_ts_|.csv", "", out$file)
table(out$tissue)
# trait
out$trait <- gsub(".*mediator_|_ts.*", "", out$file)
table(out$trait)

write.table(out, "cache/mediators_23296rows.csv", sep=",", row.names=FALSE, quote=FALSE)
```


### Filter non-significant ones

```{r}
m <- read.csv("cache/mediators_23296rows.csv")
m5 <- subset(m, padj < 0.05)
# nrow(m5) 2751
m1 <- subset(m, padj < 0.01)
# 1567

t5 <- as.data.frame(table(m5$id))
t5 <- t5[order(t5$Freq, decreasing=T),]
```

focus on only the flowering time traits

```{r}
mflowering <- subset(m5, trait %in% c("DaystoSilk",	"DaysToTassel", "GDDDaystoSilk",	"GDDDaystoTassel")) 

mflowering <- subset(mflowering, method == "res.fixed") 

male_mflowering <- subset(mflowering, trait %in% c(	"DaysToTassel",	"GDDDaystoTassel")) 
female_mflowering <- subset(mflowering, trait %in% c(	"DaystoSilk",	"GDDDaystoSilk")) 

tp <- as.data.frame(table(mt$id))
tp <- tp[order(tp$Freq, decreasing = T),]

library("readxl")
maleg<- read_excel("largedata/top_genes_associated_with_male_flowering.xlsx")
femaleg<- read_excel("largedata/top_genes_associated_with_female_flowering.xlsx")

which(male_mflowering$id %in% maleg$ID)
which(female_mflowering$id %in% femaleg$ID)

length(which(male_mflowering$id %in% maleg$ID))



Nf <- nrow(femaleg)
N <- 37127

noverlap <-length(which(female_mflowering$id %in% femaleg$ID))
n <- nrow(female_mflowering)

p <- Nf/N
obsfreq <- c(noverlap, n - noverlap)
nullprobs <- c(p, 1-p)
chisq.test(obsfreq,p=nullprobs)

```


### Mediators

```{r}

f368 <- list.files(path="/common/jyanglab/zhikaiyang/projects/mediation/largedata/med_output/", pattern="mediator_P368", full.names = T)

out <- data.frame()
for(i in 1:length(f368)){
  tem <- read.csv(f368[i], header=TRUE)
  tem$file <- f368[i]
  out <- rbind(out, tem)
}

out$file  <- gsub(".*\\/", "", out$file)
# method
out$method <- gsub("_.*", "", out$file)
# tissue type
out$tissue <- gsub(".*_ts_P368\\.|.csv", "", out$file)
table(out$tissue)
# trait
out$trait <- gsub(".*mediator_P368\\.|_ts.*", "", out$file)
table(out$trait)

write.table(out, "cache/mediators_P368.csv", sep=",", row.names=FALSE, quote=FALSE)
```


### Filter non-significant ones

```{r}
m_kern <- subset(m, tissue == "Kern")

m_368 <- read.csv("cache/mediators_P368.csv")

intersect(m_kern$id[which(m_kern$method == "res.eq")], m_368$id[which(m_368$method == "res.eq")])
#[1] "GRMZM2G305834" "GRMZM2G179679"
intersect(m_kern$id[which(m_kern$method == "res.fixed")], m_368$id[which(m_368$method == "res.fixed")])
#character(0)
GRMZM2G305834_kern <- subset(m_kern[which(m_kern$method == "res.eq"),], id == "GRMZM2G305834")
GRMZM2G305834_368 <- subset(m_368[which(m_368$method == "res.eq"),], id == "GRMZM2G305834")


m5_368 <- subset(m_368, padj < 0.05)
# nrow(m5) 2751
m1_368 <- subset(m_368, padj < 0.01)
# 1567

t5_368 <- as.data.frame(table(m5_368$id))
t5_368 <- t5_368[order(t5_368$Freq, decreasing=T),]
```



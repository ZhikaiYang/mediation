---
title: "Collect mediation analysis results"
author: "Zhikai Yang "
date: "11-2-2020"
output: NULL
---


## Normalize the path:

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
knitr::opts_knit$set(root.dir=normalizePath('../../')) 
```

### Results generated by Zhikai

/common/jyanglab/zhikaiyang/projects/mediation/largedata/med_output

fixed_dsnps : direct snps
fixed_indirect : indirect snps
fixed_mediator_trait : mediator for agronomic traits
fixed_mediator_X...: mediator for metabolic traits
fixed.pcut_sum : pvm


### New Geno on HCC

```{r}

f <- list.files(path="/common/jyanglab/zhikaiyang/projects/mediation/largedata/med_output/", pattern="pcut_sum_", full.names = T)
fmic <- list.files(path="/common/jyanglab/zhikaiyang/projects/mediation/largedata/med_output/", pattern="pcut_sum_T[[0-9]", full.names = T)
id = which(f %in% fmic)
f = f[-c(id)]
id = grep("P368", f)
f = f[-c(id)]

out <- data.frame()
for(i in 1:length(f)){
  tem <- read.csv(f[i], header=TRUE)
  tem$file <- f[i]
  out <- rbind(out, tem)
}

out$file  <- gsub(".*\\/", "", out$file)

library(data.table)

# method
out$method <- gsub(".pcut.*", "", out$file)
# tissue type
out$tissue <- gsub(".*_ts_|.csv", "", out$file)
table(out$tissue)
# trait
out$trait <- gsub(".*sum_|_ts.*", "", out$file)
table(out$trait)
id = which(out$trait == "Nitrogen")
out = out[-id,]
write.table(out, "largedata/pvm_742rows_ag_met.csv", sep=",", row.names=FALSE, quote=FALSE)
```


### on local

```{r}
library(data.table)
library(dplyr)
  
  
ag_trait <- fread("data/geno_trait.txt")
m_trait <- fread("data/metabolite_rep1_genotype_namecorrect.txt")
trait_category <- data.frame(category = "other", trait = c(colnames(ag_trait)[-1], colnames(m_trait)[-1]))

trait_category$category[c(3,4,11:13,38)]= "Flowering Time"
trait_category$category[c(6,23)]= "Development"
trait_category$category[c(15,16,36)]= "Leaf Morphology"
trait_category$category[c(32,33)]= "Male Inflorescence"
trait_category$category[c(1,7,9,8)]= "Female Inflorescence"
trait_category$category[c(2,10,35,37,39,40)]= "Seed Traits"
trait_category$category[41:106]= "Metabolite"

pvm = fread("largedata/pvm_742rows_ag_met.csv")
pvm = merge(pvm, trait_category, by = "trait", all.x = T, sort = F)

pvm_stat = (pvm %>% group_by(trait) %>% summarise(avg_pvm = mean(pmed.pure) ,avg_vmed = mean(v.med), min_vmed = min(v.med), max_vmed = max(v.med), num = n()))
ag_mean = apply(ag_trait[,2:ncol(ag_trait)], 2, mean , na.rm = T)
ag_mean = as.data.frame(ag_mean)
ag_var = apply(ag_trait[,2:ncol(ag_trait)], 2, var , na.rm = T)
ag_var = as.data.frame(ag_var)
colnames(ag_var) = "trait_var"

m_mean = apply(m_trait[,2:ncol(m_trait)], 2, mean , na.rm = T)
m_mean = as.data.frame(m_mean)
m_var = apply(m_trait[,2:ncol(m_trait)], 2, var , na.rm = T)
m_var = as.data.frame(m_var)
colnames(m_var) = "trait_var"

trait_var = rbind(ag_var, m_var)
trait_var$trait = rownames(trait_var)
pvm_stat = merge(pvm_stat, trait_var, by = "trait")

id = which(pvm$category != "Metabolite")
pvm$category[id] = "Morphology"


library(ggplot2)
library(ggpubr)

p <-ggplot(pvm, aes(x=category, y=pmed.pure, fill=tissue)) +
  geom_boxplot(outlier.colour="black", outlier.shape=16, outlier.size=1, notch=FALSE) +
   xlab("Trait Category") +
    ylab("Proportion of the Variance Mediated (PVM) ") +
    ggtitle("") +
    theme_classic() +
    labs(fill = "") +
    scale_y_continuous(limits = c(-0.01, 1)) +
    stat_compare_means(method = "t.test")+
    theme(plot.title = element_text(size=20, face = "bold"), 
          axis.text=element_text(size=16, face="bold"),
          strip.text.x = element_text(size = 16, face = "bold"),
          axis.title=element_text(size=fsize, face="bold"),
          axis.text.x = element_text(angle = 15, hjust=0.8),
          legend.position = "right", 
          legend.title = element_text(size=fsize, face="bold"),
          legend.text = element_text(size=fsize))

t.test(pvm$pmed.pure[id], pvm$pmed.pure[-id])
mean(pvm$pmed.pure[id])
mean(pvm$pmed.pure[-id], na.rm = T)

pdf("graphs/pvm_box_ag_met.pdf", width = 9, height= 6)
p
dev.off()


pvm$tissue <- factor(pvm$tissue, levels = c( "GRoot", "GShoot", "L3Base", "L3Tip", "LMAD", "LMAN","Kern"),
                    labels =c( "Germinating Root", "Germinating Shoot", "Leaf 3 base", "Leaf 3 tip", "Adult leaf during the day", "Adult leaf at night","Kernels after pollination"))
pvm$category = as.factor(pvm$category)

p <- ggboxplot(pvm, x = "tissue", y = "pmed.pure",
          color = "category", palette = "jco",
          add = "jitter")
p_tissue = p + stat_compare_means(aes(group = category), label = "p.signif")+
  xlab("Tissue") +
    ylab("Proportion of the Variance Mediated (PVM) ") +
    ggtitle("") +
    theme_classic() +
    labs(fill = "") +
    scale_y_continuous(limits = c(-0.01, 1)) +
    theme(plot.title = element_text(size=20, face = "bold"), 
          axis.text=element_text(size=16, face="bold"),
          strip.text.x = element_text(size = 16, face = "bold"),
          axis.title=element_text(size=fsize, face="bold"),
          axis.text.x = element_text(angle = 15, hjust=0.8),
          legend.position = "right", 
          legend.title = element_text(size=fsize, face="bold"),
          legend.text = element_text(size=fsize))

pdf("graphs/pvm_box_ag_met_tissue.pdf", width = 9, height= 6)
p_tissue
dev.off()



```

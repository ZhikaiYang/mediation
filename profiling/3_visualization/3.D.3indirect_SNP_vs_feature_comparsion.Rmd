---
title: "Collect mediation analysis results"
author: "Zhikai Yang "
date: "11-9-2020"
output: NULL
---


## Normalize the path:

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
knitr::opts_knit$set(root.dir=normalizePath('../../')) 
```


### on local

```{r}
library(data.table)

isnps <- fread("largedata/isnps_vs_feature/isnps_55257rows.csv")
isnps_gup5k <- fread("largedata/isnps_vs_feature/isnps_in_gene_up5k.txt")
isnps_gup5k_table <- as.data.frame(table(isnps_gup5k$snps_for_medi)) 
isnps = merge(isnps, isnps_gup5k_table, by.x = "snps_for_medi", by.y = "Var1", sort = F, all.x = T)
idx = which(is.na(isnps$Freq))
isnps$Freq[idx] = 0

isnps_eq <- subset(isnps, method == "res.eq")
isnps_fixed <- subset(isnps, method == "res.fixed")
i_trait_eq <- unique(isnps_eq$trait)
i_tissue_eq <- unique(isnps_eq$tissue)
gup5k_overlap_eq = NULL
for (trait in i_trait_eq) {
  
  for (tissue in i_tissue_eq) {
    t = intersect(which(isnps_eq$trait == trait ), which( isnps_eq$tissue == tissue))
    if (length(t) > 0) {
      tem = isnps_eq[t, ]
      o_ratio = length(which(tem$Freq != 0))/nrow(tem)
      gup5k_overlap_eq = rbind(gup5k_overlap_eq, c(trait, tissue, o_ratio, length(which(tem$Freq != 0)), nrow(tem) ))
    }
    
  }
  
}


i_trait_fixed <- unique(isnps_fixed$trait)
i_tissue_fixed <- unique(isnps_fixed$tissue)
gup5k_overlap_fixed = NULL
for (trait in i_trait_fixed) {
  
  for (tissue in i_tissue_fixed) {
    t = intersect(which(isnps_fixed$trait == trait ), which( isnps_fixed$tissue == tissue))
    if (length(t) > 0) {
      tem = isnps_fixed[t, ]
      o_ratio = length(which(tem$Freq != 0))/nrow(tem)
      gup5k_overlap_fixed = rbind(gup5k_overlap_fixed, c(trait, tissue, o_ratio, length(which(tem$Freq != 0)), nrow(tem) ))
    }
    
  }
  
}
```

```{r}
ag_trait <- fread("data/geno_trait.txt")
m_trait <- fread("data/metabolite_rep1_genotype_namecorrect.txt")
trait_category <- data.frame(category = "other", trait = c(colnames(ag_trait)[-1], colnames(m_trait)[-1]))

trait_category$category[c(3,4,11:13,38)]= "Flowering Time"
trait_category$category[c(6,23)]= "Development"
trait_category$category[c(15,16,36)]= "Leaf Morphology"
trait_category$category[c(32,33)]= "Male Inflorescence"
trait_category$category[c(1,7,9,8)]= "Female Inflorescence"
trait_category$category[c(2,10,35,37,39,40)]= "Seed Traits"
trait_category$category[41:106]= "Metabolite"

isnps = merge(isnps, trait_category, by = "trait", all.x = T, sort = F)
isnps_eq <- subset(isnps, method == "res.eq")
isnps_fixed <- subset(isnps, method == "res.fixed")

gup5k_overlap_eq = as.data.frame(gup5k_overlap_eq)
colnames(gup5k_overlap_eq) = c("trait", "tissue", "o_ratio", "num_o", "N_isnps")
gup5k_overlap_fixed = as.data.frame(gup5k_overlap_fixed)
colnames(gup5k_overlap_fixed) = c("trait", "tissue", "o_ratio", "num_o", "N_isnps")

gup5k_overlap_eq = merge(gup5k_overlap_eq, trait_category, by = "trait", all.x = T, sort = F)
gup5k_overlap_fixed = merge(gup5k_overlap_fixed, trait_category, by = "trait", all.x = T, sort = F)

```

### all plot
```{r}
fsize=18
gup5k_overlap_eq$tissue <- factor(gup5k_overlap_eq$tissue, levels = c( "GRoot", "GShoot", "L3Base", "L3Tip", "LMAD", "LMAN","Kern"),
                    labels =c( "Germinating Root", "Germinating Shoot", "Leaf 3 base", "Leaf 3 tip", "Adult leaf during the day", "Adult leaf at night","Kernels after pollination"))
gup5k_overlap_eq$o_ratio = as.numeric(gup5k_overlap_eq$o_ratio)

library(ggplot2)

#df0 <- subset(df, cat != "1")
pall <- ggplot(gup5k_overlap_eq, aes(x=tissue, y=o_ratio, fill=category)) +
    #geom_bar(stat="identity", position=position_dodge()) +
    geom_boxplot(outlier.colour="black", outlier.shape=16, 
             outlier.size=1, notch=FALSE) +
    # scale_fill_manual(values=c("#69b3a2", "#cdc0b0")) +
    # scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    # geom_jitter(color="#cc4141", size=2, alpha=0.9) +
    xlab("") +
    ylab("Overlap ratio with GWAS signals") +
    ggtitle("") +
    theme_classic() +
    labs(fill = "") +
    scale_y_continuous(limits = c(-0.01, 1)) +
    theme(plot.title = element_text(size=20, face = "bold"), 
          axis.text=element_text(size=16, face="bold"),
          strip.text.x = element_text(size = 16, face = "bold"),
          axis.title=element_text(size=fsize, face="bold"),
          axis.text.x = element_text(angle = 15, hjust=0.8),
          legend.position = "right", 
          legend.title = element_text(size=fsize, face="bold"),
          legend.text = element_text(size=fsize))
pall

pdf("graphs/overlap_ratio_gene_up_5kb_all_traits_eq.pdf", width = 9, height= 6)
pall
dev.off()

```

### all plot
```{r}
fsize=18
gup5k_overlap_fixed$tissue <- factor(gup5k_overlap_fixed$tissue, levels = c( "GRoot", "GShoot", "L3Base", "L3Tip", "LMAD", "LMAN","Kern"),
                    labels =c( "Germinating Root", "Germinating Shoot", "Leaf 3 base", "Leaf 3 tip", "Adult leaf during the day", "Adult leaf at night","Kernels after pollination"))
gup5k_overlap_fixed$o_ratio = as.numeric(gup5k_overlap_fixed$o_ratio)

library(ggplot2)

#df0 <- subset(df, cat != "1")
pall <- ggplot(gup5k_overlap_fixed, aes(x=tissue, y=o_ratio, fill=category)) +
    #geom_bar(stat="identity", position=position_dodge()) +
    geom_boxplot(outlier.colour="black", outlier.shape=16, 
             outlier.size=1, notch=FALSE) +
    # scale_fill_manual(values=c("#69b3a2", "#cdc0b0")) +
    # scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    # geom_jitter(color="#cc4141", size=2, alpha=0.9) +
    xlab("") +
    ylab("Overlap ratio with GWAS signals") +
    ggtitle("") +
    theme_classic() +
    labs(fill = "") +
    scale_y_continuous(limits = c(-0.01, 1)) +
    theme(plot.title = element_text(size=20, face = "bold"), 
          axis.text=element_text(size=16, face="bold"),
          strip.text.x = element_text(size = 16, face = "bold"),
          axis.title=element_text(size=fsize, face="bold"),
          axis.text.x = element_text(angle = 15, hjust=0.8),
          legend.position = "right", 
          legend.title = element_text(size=fsize, face="bold"),
          legend.text = element_text(size=fsize))
pall

pdf("graphs/overlap_ratio_gene_up_5kb_all_traits_fixed.pdf", width = 9, height= 6)
pall
dev.off()

```


### enrichment test
#p7msnps_gup5k: 77704, 0.111556
```{r}

gup5k_overlap_eq$p_f_null = 0.111556 
gup5k_overlap_fixed$p_f_null = 0.111556

gup5k_overlap_eq$num_o = as.numeric(gup5k_overlap_eq$num_o)
gup5k_overlap_fixed$num_o = as.numeric(gup5k_overlap_fixed$num_o)
gup5k_overlap_eq$N_isnps = as.numeric(gup5k_overlap_eq$N_isnps)
gup5k_overlap_fixed$N_isnps = as.numeric(gup5k_overlap_fixed$N_isnps)

gup5k_overlap_eq$p_val_chi = 0.0
gup5k_overlap_eq$p_val_chi_adj = 0.0
gup5k_overlap_eq$statistic_chi = 0.0
for (i in 1:nrow(gup5k_overlap_eq)) {
  t = chisq.test(c(gup5k_overlap_eq$num_o[i], gup5k_overlap_eq$N_isnps[i]-gup5k_overlap_eq$num_o[i]),p=c(gup5k_overlap_eq$p_f_null[i], 1-gup5k_overlap_eq$p_f_null[i]))
  gup5k_overlap_eq$statistic_chi[i] = t$statistic
  gup5k_overlap_eq$p_val_chi[i] = t$p.value
  gup5k_overlap_eq$p_val_chi_adj[i] = p.adjust(gup5k_overlap_eq$p_val_chi[i], method = "fdr", n= nrow(gup5k_overlap_eq))
}

gup5k_overlap_fixed$p_val_chi = 0.0
gup5k_overlap_fixed$p_val_chi_adj = 0.0
gup5k_overlap_fixed$statistic_chi = 0.0
for (i in 1:nrow(gup5k_overlap_fixed)) {
  t = chisq.test(c(gup5k_overlap_fixed$num_o[i], gup5k_overlap_fixed$N_isnps[i]-gup5k_overlap_fixed$num_o[i]),p=c(gup5k_overlap_fixed$p_f_null[i], 1-gup5k_overlap_fixed$p_f_null[i]))
  gup5k_overlap_fixed$statistic_chi[i] = t$statistic
  gup5k_overlap_fixed$p_val_chi[i] = t$p.value
  gup5k_overlap_fixed$p_val_chi_adj[i] = p.adjust(gup5k_overlap_fixed$p_val_chi[i], method = "fdr", n= nrow(gup5k_overlap_fixed))
}

length(which(gup5k_overlap_eq$p_val_chi_adj > 0.05))
length(which(gup5k_overlap_fixed$p_val_chi_adj > 0.05))



hist(gup5k_overlap_eq$p_val_chi_adj[- which(gup5k_overlap_eq$p_val_chi_adj > 0.05)], main = "Distribution of adjusted p-value by FDR (Medfix.0.5)", xlab = "adjusted p-value")

hist(gup5k_overlap_fixed$p_val_chi_adj[- which(gup5k_overlap_fixed$p_val_chi_adj > 0.05)], main = "Distribution of adjusted p-value by FDR (Medfix.bic)", xlab = "adjusted p-value")

write.table(gup5k_overlap_eq, "largedata/isnps_vs_feature/gene_up_5kb_overlap_eq.csv", sep=",", row.names=FALSE, quote=FALSE)
write.table(gup5k_overlap_fixed, "largedata/isnps_vs_feature/gene_up_5kb_overlap_fixed.csv", sep=",", row.names=FALSE, quote=FALSE)



```

